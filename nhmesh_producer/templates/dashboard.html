<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH Mesh Telemetry Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“¡</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .status-warning { color: #f59e0b; }
        .signal-excellent { color: #10b981; }
        .signal-good { color: #3b82f6; }
        .signal-fair { color: #f59e0b; }
        .signal-poor { color: #ef4444; }
        .battery-full { color: #10b981; }
        .battery-medium { color: #f59e0b; }
        .battery-low { color: #ef4444; }
        .glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">NH Mesh Telemetry</h1>
                        <p class="text-sm text-slate-400">Real-time Network Monitoring</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/traceroute" class="text-sm text-purple-400 hover:text-purple-300 flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                        </svg>
                        <span>Topology</span>
                    </a>
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse"></div>
                        <span class="text-sm text-green-400">Connected</span>
                    </div>
                    <div class="text-sm text-slate-400">
                        <span id="last-update">--</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Active Nodes</p>
                        <p class="text-3xl font-bold text-white" id="active-nodes">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Total Packets</p>
                        <p class="text-3xl font-bold text-white" id="total-packets">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Traceroute Queue</p>
                        <p class="text-3xl font-bold text-white" id="traceroute-queue-size">0</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Success Rate</p>
                        <p class="text-3xl font-bold text-white" id="traceroute-success-rate">--</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map and Nodes -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Map -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Network Map</h2>
                <div id="map" class="h-96 rounded-lg"></div>
            </div>

            <!-- Nodes List -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Active Nodes</h2>
                <div id="nodes-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-slate-400 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No nodes detected yet...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traceroute Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Traceroute Queue -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Traceroute Queue</h2>
                <div id="traceroute-queue" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-center text-slate-400 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>No pending traceroutes...</p>
                    </div>
                </div>
            </div>

            <!-- Traceroute Metrics -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Traceroute Metrics</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-slate-400 text-sm">Total Sent</p>
                            <p class="text-2xl font-bold text-white" id="total-traceroutes-sent">0</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <p class="text-slate-400 text-sm">Total Received</p>
                            <p class="text-2xl font-bold text-white" id="total-traceroutes-received">0</p>
                        </div>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-slate-400 text-sm">Average Response Time</p>
                        <p class="text-2xl font-bold text-white" id="avg-response-time">--</p>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <p class="text-slate-400 text-sm">Queue Status</p>
                        <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Pending:</span>
                                <span class="text-white" id="pending-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Replies:</span>
                                <span class="text-white" id="replies-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Recent Activity</h2>
            <div id="recent-activity" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="text-center text-slate-400 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>Waiting for activity...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize map
        const map = L.map('map').setView([43.1939, -71.5724], 8); // New Hampshire center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let markers = {};
        let updateTimer;

        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return '--';
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '--';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function getSignalQuality(rssi) {
            if (!rssi) return 'unknown';
            if (rssi >= -50) return 'excellent';
            if (rssi >= -60) return 'good';
            if (rssi >= -70) return 'fair';
            return 'poor';
        }

        function getBatteryStatus(level) {
            if (!level) return 'unknown';
            if (level >= 80) return 'full';
            if (level >= 40) return 'medium';
            return 'low';
        }

        function getNodeStatus(lastSeen) {
            if (!lastSeen) return 'offline';
            const lastSeenTime = new Date(lastSeen);
            const now = new Date();
            const diffMinutes = (now - lastSeenTime) / (1000 * 60);
            if (diffMinutes <= 5) return 'online';
            if (diffMinutes <= 30) return 'warning';
            return 'offline';
        }

        // Update functions
        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('active-nodes').textContent = data.active_nodes;
                    document.getElementById('total-packets').textContent = data.total_packets.toLocaleString();
                    document.getElementById('last-update').textContent = formatTime(data.last_update);
                })
                .catch(error => console.error('Error fetching stats:', error));
        }

        function updateTracerouteMetrics() {
            fetch('/api/traceroute-metrics')
                .then(response => response.json())
                .then(data => {
                    // Update main stats cards
                    document.getElementById('traceroute-queue-size').textContent = data.queue_size || 0;
                    document.getElementById('traceroute-success-rate').textContent = 
                        data.success_rate ? `${data.success_rate.toFixed(1)}%` : '--';
                    
                    // Update detailed metrics
                    document.getElementById('total-traceroutes-sent').textContent = data.total_traceroutes_sent || 0;
                    document.getElementById('total-traceroutes-received').textContent = data.total_traceroutes_received || 0;
                    document.getElementById('avg-response-time').textContent = 
                        data.average_response_time ? `${data.average_response_time.toFixed(1)}s` : '--';
                    document.getElementById('pending-count').textContent = data.queue_status?.total_pending || 0;
                    document.getElementById('replies-count').textContent = data.total_traceroutes_received || 0;
                    
                    // Update traceroute queue display
                    if (data.queue_status) {
                        updateTracerouteQueue(data.queue_status);
                    } else {
                        // Handle case where queue_status is missing
                        updateTracerouteQueue({ pending_traceroutes: {} });
                    }
                })
                .catch(error => {
                    console.error('Error fetching traceroute metrics:', error);
                    // Set default values on error
                    document.getElementById('traceroute-queue-size').textContent = '0';
                    document.getElementById('traceroute-success-rate').textContent = '--';
                    document.getElementById('total-traceroutes-sent').textContent = '0';
                    document.getElementById('total-traceroutes-received').textContent = '0';
                    document.getElementById('avg-response-time').textContent = '--';
                    document.getElementById('pending-count').textContent = '0';
                    document.getElementById('replies-count').textContent = '0';
                    updateTracerouteQueue({ pending_traceroutes: {} });
                });
        }

        function updateTracerouteQueue(queueStatus) {
            const queueDiv = document.getElementById('traceroute-queue');
            const pendingTraceroutes = queueStatus.pending_traceroutes || {};
            
            if (!pendingTraceroutes || Object.keys(pendingTraceroutes).length === 0) {
                queueDiv.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>No pending traceroutes...</p>
                    </div>
                `;
                return;
            }

            const currentTime = Date.now() / 1000;
            const queueItems = Object.entries(pendingTraceroutes).map(([nodeId, data]) => {
                const age = currentTime - data.timestamp;
                const ageText = age < 60 ? `${Math.floor(age)}s` : 
                               age < 3600 ? `${Math.floor(age/60)}m` : 
                               `${Math.floor(age/3600)}h`;
                
                let statusColor = 'text-green-400';
                if (age > 30) statusColor = 'text-yellow-400';
                if (age > 60) statusColor = 'text-red-400';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
                            <div>
                                <p class="font-medium text-white">${nodeId}</p>
                                <p class="text-sm text-slate-400">Retries: ${data.retries}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="text-slate-400">
                                <span class="${statusColor}">${ageText}</span>
                            </div>
                            <div class="text-slate-400">
                                Max: ${data.max_wait}s
                            </div>
                        </div>
                    </div>
                `;
            });

            queueDiv.innerHTML = queueItems.join('');
        }

        function updateNodes() {
            fetch('/api/nodes')
                .then(response => response.json())
                .then(nodes => {
                    const nodesList = document.getElementById('nodes-list');
                    const nodesArray = Object.values(nodes);
                    
                    if (nodesArray.length === 0) {
                        nodesList.innerHTML = `
                            <div class="text-center text-slate-400 py-8">
                                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>No nodes detected yet...</p>
                            </div>
                        `;
                        return;
                    }

                    // Sort by last seen (most recent first)
                    nodesArray.sort((a, b) => new Date(b.last_seen || 0) - new Date(a.last_seen || 0));

                    nodesList.innerHTML = nodesArray.map(node => {
                        const status = getNodeStatus(node.last_seen);
                        const signalQuality = getSignalQuality(node.rssi);
                        const batteryStatus = getBatteryStatus(node.battery_level);
                        
                        return `
                            <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 rounded-full status-${status}"></div>
                                    <div>
                                        <p class="font-medium text-white">${node.longname || node.shortname || node.node_id}</p>
                                        <p class="text-sm text-slate-400">${node.node_id}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4 text-sm">
                                    ${node.position ? `
                                        <div class="text-slate-400">
                                            <span class="signal-${signalQuality}">${node.rssi || '--'} dBm</span>
                                        </div>
                                    ` : ''}
                                    ${node.battery_level ? `
                                        <div class="text-slate-400">
                                            <span class="battery-${batteryStatus}">${node.battery_level}%</span>
                                        </div>
                                    ` : ''}
                                    <div class="text-slate-400">
                                        ${formatTime(node.last_seen)}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Update map markers
                    updateMapMarkers(nodes);
                })
                .catch(error => console.error('Error fetching nodes:', error));
        }

        function updateMapMarkers(nodes) {
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};

            // Add new markers
            Object.values(nodes).forEach(node => {
                if (node.position && node.position.latitude && node.position.longitude) {
                    const status = getNodeStatus(node.last_seen);
                    const signalQuality = getSignalQuality(node.rssi);
                    
                    let color = '#6b7280'; // gray for offline
                    if (status === 'online') {
                        if (signalQuality === 'excellent') color = '#10b981';
                        else if (signalQuality === 'good') color = '#3b82f6';
                        else if (signalQuality === 'fair') color = '#f59e0b';
                        else color = '#ef4444';
                    } else if (status === 'warning') {
                        color = '#f59e0b';
                    }

                    const marker = L.circleMarker([node.position.latitude, node.position.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#ffffff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    const popupContent = `
                        <div class="text-sm">
                            <p class="font-bold">${node.longname || node.shortname || node.node_id}</p>
                            <p class="text-gray-600">${node.node_id}</p>
                            ${node.battery_level ? `<p>Battery: ${node.battery_level}%</p>` : ''}
                            ${node.rssi ? `<p>Signal: ${node.rssi} dBm</p>` : ''}
                            ${node.hops_away ? `<p>Hops: ${node.hops_away}</p>` : ''}
                            <p>Last seen: ${formatTime(node.last_seen)}</p>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markers[node.node_id] = marker;
                }
            });
        }

        function updateRecentActivity() {
            fetch('/api/recent_packets')
                .then(response => response.json())
                .then(packets => {
                    const activityDiv = document.getElementById('recent-activity');
                    
                    if (packets.length === 0) {
                        activityDiv.innerHTML = `
                            <div class="text-center text-slate-400 py-8">
                                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p>Waiting for activity...</p>
                            </div>
                        `;
                        return;
                    }

                    // Show last 10 packets
                    const recentPackets = packets.slice(-10).reverse();
                    
                    activityDiv.innerHTML = recentPackets.map(packet => {
                        const nodeId = packet.fromId || packet.from_id_str || 'Unknown';
                        const nodeName = packet.longname || packet.shortname || nodeId;
                        const packetType = packet.portnum || packet.type || 'Unknown';
                        
                        return `
                            <div class="flex items-center justify-between p-3 bg-slate-700/30 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    <div>
                                        <p class="text-sm text-white">${nodeName}</p>
                                        <p class="text-xs text-slate-400">${packetType}</p>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400">
                                    ${formatTime(packet.received_at)}
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(error => console.error('Error fetching recent packets:', error));
        }

        // Initialize updates
        function startUpdates() {
            updateStats();
            updateTracerouteMetrics();
            updateNodes();
            updateRecentActivity();
            
            // Update every 5 seconds
            updateTimer = setInterval(() => {
                updateStats();
                updateTracerouteMetrics();
                updateNodes();
                updateRecentActivity();
            }, 5000);
        }

        // Start the application
        startUpdates();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
        });
    </script>
</body>
</html> 