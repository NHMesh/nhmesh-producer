<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH Mesh Traceroute Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì°</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .quality-excellent { color: #10b981; }
        .quality-good { color: #3b82f6; }
        .quality-fair { color: #f59e0b; }
        .quality-poor { color: #ef4444; }
        .quality-unknown { color: #6b7280; }
        .glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .route-line {
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .route-excellent { stroke: #10b981; }
        .route-good { stroke: #3b82f6; }
        .route-fair { stroke: #f59e0b; }
        .route-poor { stroke: #ef4444; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Network Topology</h1>
                        <p class="text-sm text-slate-400">Traceroute Analysis & Route Quality</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-sm text-blue-400 hover:text-blue-300">‚Üê Back to Dashboard</a>
                    <div class="text-sm text-slate-400">
                        <span id="last-update">--</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Total Routes</p>
                        <p class="text-3xl font-bold text-white" id="total-routes">0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Avg Hops</p>
                        <p class="text-3xl font-bold text-white" id="avg-hops">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Route Quality</p>
                        <p class="text-3xl font-bold text-white" id="route-quality">--</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-6 glow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Active Routes</p>
                        <p class="text-3xl font-bold text-white" id="active-routes">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topology Map and Route Details -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Topology Map -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Network Topology</h2>
                <div id="topology-map" class="h-96 rounded-lg"></div>
            </div>

            <!-- Route Quality Distribution -->
            <div class="card rounded-xl p-6">
                <h2 class="text-lg font-semibold text-white mb-4">Route Quality Distribution</h2>
                <canvas id="quality-chart" class="h-96"></canvas>
            </div>
        </div>

        <!-- Recent Traceroutes -->
        <div class="card rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Recent Traceroutes</h2>
            <div id="recent-traceroutes" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-center text-slate-400 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                    </svg>
                    <p>Waiting for traceroute data...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize map
        const map = L.map('topology-map').setView([43.1939, -71.5724], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let qualityChart;
        let updateTimer;

        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return '--';
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        function getQualityColor(quality) {
            switch(quality) {
                case 'excellent': return '#10b981';
                case 'good': return '#3b82f6';
                case 'fair': return '#f59e0b';
                case 'poor': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function getQualityClass(quality) {
            return `quality-${quality}`;
        }

        // Update functions
        function updateTopology() {
            fetch('/api/network-topology')
                .then(response => response.json())
                .then(data => {
                    // Update stats
                    document.getElementById('total-routes').textContent = data.total_routes || 0;
                    document.getElementById('avg-hops').textContent = (data.route_statistics?.avg_hops || 0).toFixed(1);
                    document.getElementById('active-routes').textContent = data.nodes_with_traceroutes || 0;
                    
                    // Calculate overall route quality
                    const qualityDist = data.route_statistics?.route_quality_distribution || {};
                    const total = Object.values(qualityDist).reduce((a, b) => a + b, 0);
                    if (total > 0) {
                        const excellent = qualityDist.excellent || 0;
                        const good = qualityDist.good || 0;
                        const quality = (excellent + good) / total * 100;
                        document.getElementById('route-quality').textContent = `${quality.toFixed(0)}%`;
                    } else {
                        document.getElementById('route-quality').textContent = '--';
                    }

                    // Update quality chart
                    updateQualityChart(data.route_statistics?.route_quality_distribution || {});

                    // Update recent traceroutes
                    updateRecentTraceroutes(data.recent_traceroutes || []);

                    // Update topology map
                    updateTopologyMap(data);
                })
                .catch(error => console.error('Error fetching topology:', error));
        }

        function updateQualityChart(qualityDistribution) {
            const ctx = document.getElementById('quality-chart').getContext('2d');
            
            if (qualityChart) {
                qualityChart.destroy();
            }

            const labels = Object.keys(qualityDistribution);
            const data = Object.values(qualityDistribution);
            const colors = labels.map(label => getQualityColor(label));

            qualityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e2e8f0',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateRecentTraceroutes(traceroutes) {
            const container = document.getElementById('recent-traceroutes');
            
            if (traceroutes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                        </svg>
                        <p>No traceroute data available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = traceroutes.map(route => `
                <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full ${getQualityClass(route.route_quality)}"></div>
                        <div>
                            <p class="font-medium text-white">${route.node_name || route.node_id}</p>
                            <p class="text-sm text-slate-400">${route.hop_count} hops</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="text-slate-400">
                            <span class="${getQualityClass(route.route_quality)}">${route.route_quality}</span>
                        </div>
                        ${route.avg_snr ? `
                            <div class="text-slate-400">
                                SNR: ${route.avg_snr.toFixed(1)} dB
                            </div>
                        ` : ''}
                        <div class="text-slate-400">
                            ${formatTime(route.timestamp)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTopologyMap(topologyData) {
            // Clear existing markers and routes
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Add nodes and routes to map
            // This would need to be enhanced with actual node positions
            // For now, we'll show a placeholder
        }

        // Initialize updates
        function startUpdates() {
            updateTopology();
            
            // Update every 10 seconds
            updateTimer = setInterval(() => {
                updateTopology();
            }, 10000);
        }

        // Start the application
        startUpdates();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            if (qualityChart) {
                qualityChart.destroy();
            }
        });
    </script>
</body>
</html> 